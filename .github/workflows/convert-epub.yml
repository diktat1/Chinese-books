name: Convert Chinese EPUB to Graded Reader

on:
  # Manual trigger with simplified options
  workflow_dispatch:
    inputs:
      epub_filename:
        description: 'EPUB filename (from input-epubs/ folder or uploaded artifact)'
        type: string
        required: true
      artifact_name:
        description: 'Artifact name if EPUB was uploaded (leave empty for input-epubs/)'
        type: string
        required: false
      translate_to:
        description: 'Translation language'
        type: choice
        options:
          - fr
          - en
          - ja
          - ko
          - de
          - es
          - it
          - pt
        default: 'fr'
      tier:
        description: 'Translation engine tier'
        type: choice
        options:
          - free (Google Translate, no API key)
          - standard (DeepSeek V3, ~$0.10/book)
          - premium (Claude Sonnet 4.5, ~$1.65/book)
        default: 'free (Google Translate, no API key)'
      model_override:
        description: 'Override model (OpenRouter ID, leave empty for tier default)'
        type: string
        required: false
      simplify_hsk4:
        description: 'Simplify vocabulary to HSK 4 level (requires LLM)'
        type: boolean
        default: false
      generate_epub:
        description: 'Generate graded reader EPUB'
        type: boolean
        default: true
      generate_anki:
        description: 'Generate Anki flashcard deck'
        type: boolean
        default: false
      generate_audio:
        description: 'Generate audiobook (edge-tts, bilingual)'
        type: boolean
        default: false

  # API trigger for external systems
  repository_dispatch:
    types: [convert-epub]

  # File-based trigger when EPUBs are added to input-epubs/
  push:
    paths:
      - 'input-epubs/**/*.epub'
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'

concurrency:
  group: convert-${{ github.ref }}-${{ github.event.inputs.epub_filename || github.event.client_payload.epub_filename || 'file-trigger' }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      skip: ${{ steps.prepare.outputs.skip }}
      trigger_type: ${{ steps.params.outputs.trigger_type }}
      translate_to: ${{ steps.params.outputs.translate_to }}
      generate_epub: ${{ steps.params.outputs.generate_epub }}
      generate_anki: ${{ steps.params.outputs.generate_anki }}
      generate_audio: ${{ steps.params.outputs.generate_audio }}
      add_pinyin: ${{ steps.params.outputs.add_pinyin }}
      add_translation: ${{ steps.params.outputs.add_translation }}
      word_spacing: ${{ steps.params.outputs.word_spacing }}
      simplify_hsk4: ${{ steps.params.outputs.simplify_hsk4 }}
      llm_model: ${{ steps.params.outputs.llm_model }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "trigger_type=workflow_dispatch" >> $GITHUB_OUTPUT
            echo "epub_filename=${{ inputs.epub_filename }}" >> $GITHUB_OUTPUT
            echo "artifact_name=${{ inputs.artifact_name }}" >> $GITHUB_OUTPUT
            echo "translate_to=${{ inputs.translate_to }}" >> $GITHUB_OUTPUT
            echo "generate_epub=${{ inputs.generate_epub }}" >> $GITHUB_OUTPUT
            echo "generate_anki=${{ inputs.generate_anki }}" >> $GITHUB_OUTPUT
            echo "generate_audio=${{ inputs.generate_audio }}" >> $GITHUB_OUTPUT
            echo "simplify_hsk4=${{ inputs.simplify_hsk4 }}" >> $GITHUB_OUTPUT

            # Smart defaults: always enable pinyin + translation + word spacing
            echo "add_pinyin=true" >> $GITHUB_OUTPUT
            echo "add_translation=true" >> $GITHUB_OUTPUT
            echo "word_spacing=true" >> $GITHUB_OUTPUT

            # Map tier to LLM model, with optional override
            TIER="${{ inputs.tier }}"
            MODEL_OVERRIDE="${{ inputs.model_override }}"
            if [ -n "$MODEL_OVERRIDE" ]; then
              echo "llm_model=$MODEL_OVERRIDE" >> $GITHUB_OUTPUT
            else
              case "$TIER" in
                "standard"*)
                  echo "llm_model=deepseek/deepseek-chat" >> $GITHUB_OUTPUT
                  ;;
                "premium"*)
                  echo "llm_model=anthropic/claude-sonnet-4-5" >> $GITHUB_OUTPUT
                  ;;
                *)
                  echo "llm_model=" >> $GITHUB_OUTPUT
                  ;;
              esac
            fi

          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "trigger_type=repository_dispatch" >> $GITHUB_OUTPUT

            TRANSLATE_TO="${{ github.event.client_payload.translate_to }}"
            echo "epub_filename=${{ github.event.client_payload.epub_filename }}" >> $GITHUB_OUTPUT
            echo "artifact_name=${{ github.event.client_payload.artifact_name }}" >> $GITHUB_OUTPUT
            echo "translate_to=${TRANSLATE_TO:-fr}" >> $GITHUB_OUTPUT

            GENERATE_EPUB="${{ github.event.client_payload.generate_epub }}"
            echo "generate_epub=${GENERATE_EPUB:-true}" >> $GITHUB_OUTPUT

            GENERATE_ANKI="${{ github.event.client_payload.generate_anki }}"
            echo "generate_anki=${GENERATE_ANKI:-false}" >> $GITHUB_OUTPUT

            GENERATE_AUDIO="${{ github.event.client_payload.generate_audio }}"
            echo "generate_audio=${GENERATE_AUDIO:-false}" >> $GITHUB_OUTPUT

            ADD_PINYIN="${{ github.event.client_payload.add_pinyin }}"
            echo "add_pinyin=${ADD_PINYIN:-true}" >> $GITHUB_OUTPUT
            ADD_TRANSLATION="${{ github.event.client_payload.add_translation }}"
            echo "add_translation=${ADD_TRANSLATION:-true}" >> $GITHUB_OUTPUT
            WORD_SPACING="${{ github.event.client_payload.word_spacing }}"
            echo "word_spacing=${WORD_SPACING:-true}" >> $GITHUB_OUTPUT

            SIMPLIFY_HSK4="${{ github.event.client_payload.simplify_hsk4 }}"
            echo "simplify_hsk4=${SIMPLIFY_HSK4:-false}" >> $GITHUB_OUTPUT

            LLM_MODEL="${{ github.event.client_payload.llm_model }}"
            echo "llm_model=${LLM_MODEL:-}" >> $GITHUB_OUTPUT

          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "trigger_type=push" >> $GITHUB_OUTPUT
            echo "epub_filename=" >> $GITHUB_OUTPUT
            echo "artifact_name=" >> $GITHUB_OUTPUT
            echo "generate_epub=true" >> $GITHUB_OUTPUT
            echo "generate_anki=false" >> $GITHUB_OUTPUT
            echo "generate_audio=false" >> $GITHUB_OUTPUT

            # Load from config.json if present, otherwise use defaults
            if [ -f "./input-epubs/config.json" ]; then
              echo "Loading options from input-epubs/config.json"
              cat ./input-epubs/config.json
              echo "translate_to=$(jq -r '.translation_target // "fr"' ./input-epubs/config.json)" >> $GITHUB_OUTPUT
              echo "add_pinyin=$(jq -r '.add_pinyin // true' ./input-epubs/config.json)" >> $GITHUB_OUTPUT
              echo "add_translation=$(jq -r '.add_translation // true' ./input-epubs/config.json)" >> $GITHUB_OUTPUT
              echo "word_spacing=$(jq -r '.word_spacing // true' ./input-epubs/config.json)" >> $GITHUB_OUTPUT
              echo "simplify_hsk4=$(jq -r '.simplify_hsk4 // false' ./input-epubs/config.json)" >> $GITHUB_OUTPUT
              echo "llm_model=$(jq -r '.llm_model // ""' ./input-epubs/config.json)" >> $GITHUB_OUTPUT

              GENERATE_ANKI=$(jq -r '.generate_anki // false' ./input-epubs/config.json)
              echo "generate_anki=${GENERATE_ANKI}" >> $GITHUB_OUTPUT
            else
              echo "translate_to=fr" >> $GITHUB_OUTPUT
              echo "add_pinyin=true" >> $GITHUB_OUTPUT
              echo "add_translation=true" >> $GITHUB_OUTPUT
              echo "word_spacing=true" >> $GITHUB_OUTPUT
              echo "simplify_hsk4=false" >> $GITHUB_OUTPUT
              echo "llm_model=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Validate OpenRouter API key (if needed)
        if: steps.params.outputs.simplify_hsk4 == 'true' || steps.params.outputs.llm_model != ''
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::error::OPENROUTER_API_KEY secret required. Add it in Settings > Secrets > Actions."
            exit 1
          fi

      - name: Download input artifact
        if: steps.params.outputs.trigger_type != 'push' && steps.params.outputs.artifact_name != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.params.outputs.artifact_name }}
          path: ./input
        continue-on-error: true

      - name: Prepare input files
        id: prepare
        run: |
          mkdir -p ./input

          if [ "${{ steps.params.outputs.trigger_type }}" == "push" ]; then
            # Find changed or all EPUB files
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'input-epubs/**/*.epub' > changed_files.txt 2>/dev/null || true
            git diff --name-status ${{ github.event.before }} ${{ github.sha }} -- 'input-epubs/**/*.epub' | grep "^A" | cut -f2 >> changed_files.txt 2>/dev/null || true

            FOUND=0
            while IFS= read -r file; do
              if [ -n "$file" ] && [ -f "$file" ]; then
                cp "$file" ./input/
                FOUND=$((FOUND + 1))
              fi
            done < changed_files.txt

            if [ "$FOUND" -eq 0 ]; then
              for file in input-epubs/*.epub; do
                [ -f "$file" ] && cp "$file" ./input/ && FOUND=$((FOUND + 1))
              done
            fi

            if [ "$FOUND" -eq 0 ]; then
              echo "::warning::No EPUB files found"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            EPUB_FILENAME="${{ steps.params.outputs.epub_filename }}"
            if [ -f "./input/$EPUB_FILENAME" ]; then
              echo "Found in artifact: $EPUB_FILENAME"
            elif [ -f "./input-epubs/$EPUB_FILENAME" ]; then
              cp "./input-epubs/$EPUB_FILENAME" ./input/
            else
              echo "::error::EPUB not found: $EPUB_FILENAME"
              exit 1
            fi
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload input files
        if: steps.prepare.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: input-epubs-${{ github.run_id }}
          path: ./input/*.epub
          retention-days: 1

  convert:
    name: Convert EPUB
    needs: prepare
    if: needs.prepare.outputs.skip != 'true' && needs.prepare.outputs.generate_epub == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download input files
        uses: actions/download-artifact@v4
        with:
          name: input-epubs-${{ github.run_id }}
          path: ./input

      - name: Convert EPUB(s)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          mkdir -p ./output
          TRANSLATE_TO="${{ needs.prepare.outputs.translate_to }}"
          ADD_PINYIN="${{ needs.prepare.outputs.add_pinyin }}"
          ADD_TRANSLATION="${{ needs.prepare.outputs.add_translation }}"
          WORD_SPACING="${{ needs.prepare.outputs.word_spacing }}"
          SIMPLIFY_HSK4="${{ needs.prepare.outputs.simplify_hsk4 }}"
          LLM_MODEL="${{ needs.prepare.outputs.llm_model }}"

          for INPUT_FILE in ./input/*.epub; do
            [ -f "$INPUT_FILE" ] || continue

            BASENAME=$(basename "$INPUT_FILE" .epub)
            OUTPUT_FILE="./output/${BASENAME}_graded.epub"

            echo "=========================================="
            echo "Converting: $INPUT_FILE â†’ $OUTPUT_FILE"
            echo "=========================================="

            CMD="python convert.py \"$INPUT_FILE\" -o \"$OUTPUT_FILE\""
            CMD="$CMD --source zh-CN --target \"$TRANSLATE_TO\""

            [ "$ADD_PINYIN" != "true" ] && [ "$ADD_TRANSLATION" == "true" ] && CMD="$CMD --translation-only"
            [ "$ADD_PINYIN" == "true" ] && [ "$ADD_TRANSLATION" != "true" ] && CMD="$CMD --pinyin-only"
            [ "$WORD_SPACING" == "true" ] && CMD="$CMD --word-spacing"
            [ "$SIMPLIFY_HSK4" == "true" ] && CMD="$CMD --simplify-hsk4"
            [ -n "$LLM_MODEL" ] && CMD="$CMD --model \"$LLM_MODEL\""

            echo "Running: $CMD"
            eval $CMD
          done

          echo ""
          echo "Output files:"
          ls -la ./output/

      - name: Upload EPUB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: converted-epub-${{ github.run_id }}
          path: ./output/*.epub
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        run: |
          echo "## Conversion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Translation | ${{ needs.prepare.outputs.translate_to }} |" >> $GITHUB_STEP_SUMMARY
          LLM_MODEL="${{ needs.prepare.outputs.llm_model }}"
          if [ -n "$LLM_MODEL" ]; then
            echo "| Engine | $LLM_MODEL |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Engine | Google Translate (free) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| HSK 4 Simplify | ${{ needs.prepare.outputs.simplify_hsk4 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Anki deck | ${{ needs.prepare.outputs.generate_anki }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Audiobook | ${{ needs.prepare.outputs.generate_audio }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la ./output/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from the Artifacts section below." >> $GITHUB_STEP_SUMMARY

  anki:
    name: Generate Anki Deck
    needs: prepare
    if: needs.prepare.outputs.skip != 'true' && needs.prepare.outputs.generate_anki == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Download input files
        uses: actions/download-artifact@v4
        with:
          name: input-epubs-${{ github.run_id }}
          path: ./input

      - name: Generate Anki decks
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          mkdir -p ./output
          TRANSLATE_TO="${{ needs.prepare.outputs.translate_to }}"
          LLM_MODEL="${{ needs.prepare.outputs.llm_model }}"

          for INPUT_FILE in ./input/*.epub; do
            [ -f "$INPUT_FILE" ] || continue

            BASENAME=$(basename "$INPUT_FILE" .epub)
            ANKI_FILE="./output/${BASENAME}_anki.apkg"

            echo "Generating Anki deck: $ANKI_FILE"

            CMD="python convert.py \"$INPUT_FILE\" -o \"$ANKI_FILE\" --anki --target \"$TRANSLATE_TO\""
            [ -n "$LLM_MODEL" ] && CMD="$CMD --model \"$LLM_MODEL\""

            eval $CMD
          done

      - name: Upload Anki artifacts
        uses: actions/upload-artifact@v4
        with:
          name: anki-deck-${{ github.run_id }}
          path: ./output/*.apkg
          retention-days: 30
          if-no-files-found: warn

  audio:
    name: Generate Audiobook
    needs: prepare
    if: needs.prepare.outputs.skip != 'true' && needs.prepare.outputs.generate_audio == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y ffmpeg espeak-ng

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install kokoro soundfile "misaki[zh]" numpy || echo "Kokoro fallback not available"

      - name: Download input files
        uses: actions/download-artifact@v4
        with:
          name: input-epubs-${{ github.run_id }}
          path: ./input

      - name: Generate audiobook
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          mkdir -p ./output
          TRANSLATE_TO="${{ needs.prepare.outputs.translate_to }}"
          LLM_MODEL="${{ needs.prepare.outputs.llm_model }}"

          for INPUT_FILE in ./input/*.epub; do
            [ -f "$INPUT_FILE" ] || continue

            BASENAME=$(basename "$INPUT_FILE" .epub)
            AUDIO_FILE="./output/${BASENAME}_audiobook.m4b"

            echo "Generating audiobook: $AUDIO_FILE"

            CMD="python convert.py \"$INPUT_FILE\" -o \"$AUDIO_FILE\" --audio --target \"$TRANSLATE_TO\""
            [ -n "$LLM_MODEL" ] && CMD="$CMD --model \"$LLM_MODEL\""

            eval $CMD
          done

      - name: Upload audiobook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audiobook-${{ github.run_id }}
          path: ./output/*_audiobook.*
          retention-days: 30
          if-no-files-found: warn

  notify:
    name: Send Notification
    needs: [convert, anki, audio]
    if: |
      always() &&
      github.event_name == 'repository_dispatch' &&
      github.event.client_payload.callback_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Notify callback URL
        run: |
          STATUS="completed"
          if [ "${{ needs.convert.result }}" != "success" ]; then
            STATUS="failed"
          fi

          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"run_id\": \"${{ github.run_id }}\",
              \"repository\": \"${{ github.repository }}\",
              \"artifacts_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" || echo "Callback notification failed (non-fatal)"
